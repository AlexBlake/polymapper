function reloadMap(){map.setView(new ol.View({center:ol.proj.fromLonLat(persistent_geo.viewpoint),zoom:persistent_geo.zoom})),vectorSource.addFeatures((new ol.format.GeoJSON).readFeatures(persistent_geo.collection)),vectorSource.refresh(),vectorSource.changed()}function addInteraction(){(draw=new ol.interaction.Draw({source:source,type:"Polygon"})).on("drawend",persistPolygon),map.addInteraction(draw),draw.setActive(!1),draw_active=!1}function persistPolygon(e){persistent_geo.collection.features.push({type:"Feature",properties:{details:{}},geometry:{type:"Polygon",coordinates:[e.target.I]}}),vectorSource.addFeatures((new ol.format.GeoJSON).readFeatures(persistent_geo.collection)),vectorSource.refresh(),vectorSource.changed(),displayModal(e)}function toggleDrawing(e){var t=$(e.target);draw_active?(draw.setActive(!1),draw_active=!1,t.removeClass("btn-default").addClass("btn-info").html("Enable Drawing")):(draw.setActive(!0),draw_active=!0,t.removeClass("btn-info").addClass("btn-default").html("Disable Drawing"))}function loadFile(){var e,t,o;"function"==typeof window.FileReader?(e=document.getElementById("fileinput"))?e.files?e.files[0]?(t=e.files[0],(o=new FileReader).onload=function(e){lines=e.target.result,persistent_geo=JSON.parse(lines),reloadMap()},o.readAsText(t)):alert("Please select a file before clicking 'Load'"):alert("This browser doesn't seem to support the `files` property of file inputs."):alert("Um, couldn't find the fileinput element."):alert("The file API isn't supported on this browser yet.")}function download(){persistent_geo.viewpoint=ol.proj.toLonLat(map.getView().getCenter()),persistent_geo.zoom=map.getView().getZoom();var e=new Blob([JSON.stringify(persistent_geo)],{"text/plain":"text/plain"}),t=window.prompt("Filename:","MapData"),o=document.createElement("a");o.href=URL.createObjectURL(e),o.download=t.indexOf(".json")>=0?t:t+".json",o.click()}function displayTooltip(e){if(!draw_active){var t=e.pixel,o=map.forEachFeatureAtPixel(t,function(e){return e});tooltip.style.display=o?"":"none",o&&(overlay.setPosition(e.coordinate),tooltip.innerHTML=o.get("details"))}}function displayModal(e){if(!draw_active){var t=e.pixel;if(modalFeature=map.forEachFeatureAtPixel(t,function(e){return e})){$(modal).find(".modal-body").html(retrieveDetailHTML(modalFeature.get("details")));var o=$(modal).modal();o.on("hide.bs.modal",function(e){modalFeature.set("details",saveDetails(this)),persistent_geo.collection=JSON.parse((new ol.format.GeoJSON).writeFeatures(map.getLayers().getArray()[2].getSource().getFeatures())),$(this).find(".modal-body").html(""),o.unbind()})}}}function retrieveDetailHTML(e){var t="";for(var o in e)t+=generateFieldHTML(o,e[o]);return t}function generateFieldHTML(e,t){return'<div class="form-group col-xs-12" data-key="'+e+'">        <label class="form-label">'+t.title+'</label>        <button class="btn btn-danger btn-xs pull-right" onclick="removeDataField(\''+e+'\')">X</button>        <textarea class="form-control" data-title="'+t.title+'" data-saveto="'+e+'">'+t.value+"</textarea>    </div>"}function addDataField(){var e=window.prompt("Field Title",""),t=toSnakeCase(e);$(modal).find(".modal-body").append(generateFieldHTML(t,{title:e,value:""}))}function removeDataField(e){var t=modalFeature.get("details");void 0!==t[e]&&(delete t[e],modalFeature.set("details",t),$(modal).find(".modal-body").find('[data-key="'+e+'"]').remove())}function saveDetails(e){var t={};return $(e).find("textarea[data-saveto]").each(function(e,o){console.log(o),t[$(o).attr("data-saveto")]={title:$(o).attr("data-title"),value:$(o).val()}}),t}function toSnakeCase(e){return e.toLowerCase().replace(/\s/g,"_").replace(/[^a-zA-Z0-9_]/g,"")}var default_viewport=[0,0],default_zoom=2,persistent_geo={viewpoint:default_viewport,zoom:default_zoom,collection:{type:"FeatureCollection",crs:{type:"name",properties:{name:"EPSG:3857"}},features:[]}},vectorSource=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(persistent_geo.collection)}),vectorLayer=new ol.layer.Vector({source:vectorSource}),source=new ol.source.Vector({wrapX:!1}),vector=new ol.layer.Vector({source:source}),map=new ol.Map({target:"main-map",layers:[new ol.layer.Tile({source:new ol.source.OSM}),vector,vectorLayer],view:new ol.View({center:ol.proj.fromLonLat(persistent_geo.viewpoint),zoom:persistent_geo.zoom})});addInteraction();var draw,draw_active=!1;document.addEventListener("keydown",function(e){27==e.which&&draw.removeLastPoint()});var tooltip=document.getElementById("tooltip"),overlay=new ol.Overlay({element:tooltip,offset:[10,0],positioning:"bottom-left"});map.addOverlay(overlay);var modal=document.getElementById("modal-detail"),modalFeature={};map.on("click",displayModal);